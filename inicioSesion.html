<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>Inicio de Sesión</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="eCommerceAssets/styles/eCommerceStyle.css" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Montserrat:300,400,600|Open+Sans" rel="stylesheet"> 
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css">
        <link href="css/bootstrap-4.4.1.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
        <script src="js/autenticacionabi.js"></script>
        <script>var _adobewebfontsappname_ = "dreamweaver"</script><script src="http://use.edgefonts.net/montserrat:n4:default;source-sans-pro:n2:default.js" type="text/javascript"></script>
        <link rel="stylesheet" href="css/estilo.css">
        <link rel="stylesheet" href="css/font-awesome.css">
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-XR5PEB3RDF"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'G-XR5PEB3RDF');
        </script>
    </head>

    <body>

<script>
    window.addEventListener('load', function() {
        // Aquí se comprueba si Web3.js ha sido inyecto por el navegador (Mist/MetaMask)
        if (typeof web3 !== 'undefined') {
        alert("MetaMask detectado");
          // Usar el proveedor Mist/MetaMask
          web3js = new Web3(web3.currentProvider);
        } else {
          // Aquí se podría poner algo para avisar al usuario de que no tiene Metamask o Mist instalado
          alert("Install Metamask");
          web3js = new Web3(new Web3.providers.HttpProvider("http://localhost:7545"));
          // Probablemente mostrarle un mensake pidiéndole que se lo instale
        }
        // Ahora ya puedes acceder libremente a tu DApp y usar Web3:
        start();
      })
            var Autenticacion;
            var userAccount;
            var inicioEvento;
            function start(){
                var autenticacionAdd = '0xd3ce7c020326cc803d4818e2515722f572b0b063';
                Autenticacion = new web3js.eth.Contract(AutenticacionABI, autenticacionAdd);
                
         var accountInterval = setInterval(function() {
          // Comprobar si la cuenta ha sido cambiada
          if (web3.eth.accounts[0] !== userAccount) {
            userAccount = web3.eth.accounts[0];
            
            // Llamar la función que va a updatear la UI with de la nueva cuenta
            
          }
        }, 100);
            }
            function iniciar(usuario, contraseña){
                $("#txStatus").text("Ingresando");
                return Autenticacion.methods.iniciarSesion(usuario,contraseña)
        .send({ from: userAccount })
        .on("receipt", function(receipt) {
          $("#txStatus").text("Successfully ingresated " + usuario + "!");          
          alert("Ingreso exitoso");
          location.replace("votacion.html");
        })
        .on("error", function(error) {
          // Se avisa al usuario de que su transacción no ha sido completada con éxito
          $("#txStatus").text(error);
          alert("Error en los datos de autenticación");
        });

            }

            function IniciarBtn(){
                var xhttp = new XMLHttpRequest();
                  xhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                      document.getElementById("demo").innerHTML =
                      this.responseText;
                    }
                  };
                  xhttp.open("POST", "inicioSesion.html", true);
                  xhttp.send();
                var user = document.getElementById("user").value;
                var contrasena = document.getElementById("contraseña").value;
                iniciar(user, contrasena);

            }
            

        </script>>

    <center>
        <section class="form_login">
            <section class="inicio_sesionimg">

            </section>
            <center>
                <form method="get" class="form_contact">
                    <h2>Iniciar sesión</h2>
                    <div class="inicio_sesion">

                        <label for="user">Usuario</label>
                        <input type="text" name="user" id="user" required>

                        <label for="contraseña">Contraseña</label>
                        <input type="password" name="password"  id="contraseña" required>                         

                        <center>      
                            <input type="button" name="sesion" value="Iniciar sesión" id="btnSend" onclick="IniciarBtn()">
                        </center>
                    </div>
                </form>
                <form class="form_contact">        
                    <div>
                        <h4>¿No tienes una cuenta?</h4> 
                        <center>
                            <input type="button" value="Regístrate" id="btnSend" onclick="location.href = 'registroUsuario.html'">
                        </center>
                    </div>
                </form>
            </center>
        </section>


    </center>	

    <script src="js/VentanasMini.js"></script>
    <script src="js/popup.js"></script>
    <script src="js/jquery-3.4.1.min.js"></script>
    <script src="js/popper.min.js"></script>
    <script src="js/bootstrap-4.4.1.js"></script>
    </body>

</html>